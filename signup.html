<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sign Up</title>
  <link rel="stylesheet" href="./style.css">
  <script src="config.js"></script>
  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const base = document.createElement('base');
      base.href = location.hostname === 'localhost' ? '/' : 'https://joshthinh.github.io/Elen-Signin/';
      document.head.appendChild(base);
      window.base = base; // Make base globally accessible
  
      // Ensure config.js is loaded before accessing API_URL / API_URL_DEPLOYED
      if (typeof API_URL === 'undefined' || typeof API_URL_DEPLOYED === 'undefined') {
        console.error('API_URL or API_URL_DEPLOYED is not defined. Check config.js loading.');
        return;
      }
  
      window.ApiUrlLink = location.hostname === 'localhost' ? API_URL : API_URL_DEPLOYED;
  
      // Continue rest of logic here if needed
    });
  </script>
  <style>
    /* Responsive scaling variables */
    :root {
      --scale-phone: 0.8;
      --scale-tablet: 0.9;
      --scale-desktop: 1;
      --scale-tv: 1.1;
    }
    
    /* Global viewport control */
    * {
      box-sizing: border-box;
    }
    
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 20px;
      overflow-x: hidden !important;
      max-width: 100vw !important;
      width: 100vw !important;
    }
    .signup-container {
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 600px;
      width: 100%;
    }
    h1 {
      margin-bottom: 30px;
      color: #333;
      font-size: 2rem;
      font-weight: bold;
    }
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    input[type="text"], input[type="email"], input[type="password"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button[type="submit"], #continueBtn {
      width: 100%;
      padding: 12px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 20px;
      font-size: 16px;
    }
    button[type="submit"]:hover, #continueBtn:hover {
      background-color: #218838;
    }
    .desk-selectable { 
      cursor: pointer; 
      border: 2px solid transparent; 
      transition: border 0.2s; 
    }
    .desk-selectable.selected { 
      border: 2px solid #007bff; 
      background: #e6f0ff; 
    }
    .desk-selectable.disabled {
      opacity: 0.3;
      pointer-events: none;
    }
    .desk-selectable.current {
      border: 2px solid #28a745;
      background: #d4edda;
    }
    
    /* iPhone and small phones (up to 428px) */
    @media screen and (max-width: 428px) {
      :root {
        --scale-phone: 0.75;
        --scale-tablet: 0.8;
        --scale-desktop: 0.85;
        --scale-tv: 0.9;
      }
      
      body {
        font-size: calc(14px * var(--scale-phone));
        padding: calc(10px * var(--scale-phone));
      }
      
      .signup-container {
        padding: calc(20px * var(--scale-phone)) !important;
        margin: calc(10px * var(--scale-phone)) !important;
        max-width: calc(100vw - 20px) !important;
        width: calc(100vw - 20px) !important;
        border-radius: calc(8px * var(--scale-phone)) !important;
        box-shadow: 0 calc(4px * var(--scale-phone)) calc(6px * var(--scale-phone)) rgba(0, 0, 0, 0.1) !important;
      }
      
      h1 {
        font-size: calc(1.5rem * var(--scale-phone));
        margin-bottom: calc(20px * var(--scale-phone));
      }
      
      .form-group {
        margin-bottom: calc(15px * var(--scale-phone));
      }
      
      label {
        font-size: calc(14px * var(--scale-phone));
        margin-bottom: calc(4px * var(--scale-phone));
      }
      
      input[type="text"], input[type="email"], input[type="password"], select {
        padding: calc(10px * var(--scale-phone));
        border-radius: calc(4px * var(--scale-phone));
        font-size: calc(14px * var(--scale-phone));
      }
      
      button[type="submit"], #continueBtn {
        padding: calc(10px * var(--scale-phone));
        border-radius: calc(4px * var(--scale-phone));
        font-size: calc(14px * var(--scale-phone));
        margin-top: calc(15px * var(--scale-phone));
      }
      
      #backToLoginBtn {
        padding: calc(8px * var(--scale-phone)) calc(16px * var(--scale-phone));
        border-radius: calc(4px * var(--scale-phone));
        font-size: calc(13px * var(--scale-phone));
      }
      
      /* Avatar grid scaling */
      #avatarGrid {
        gap: calc(8px * var(--scale-phone)) !important;
        margin-bottom: calc(8px * var(--scale-phone)) !important;
      }
      
      #avatarGrid canvas {
        width: calc(48px * var(--scale-phone)) !important;
        height: calc(48px * var(--scale-phone)) !important;
        margin: calc(2px * var(--scale-phone)) !important;
        border-radius: calc(6px * var(--scale-phone)) !important;
      }
      
      /* Desk grid scaling */
      #deskGrid table td {
        width: calc(24px * var(--scale-phone)) !important;
        height: calc(24px * var(--scale-phone)) !important;
        font-size: calc(12px * var(--scale-phone)) !important;
      }
      
      /* Label scaling for desk selection */
      label[for="deskSelection"] {
        font-size: calc(16px * var(--scale-phone)) !important;
        margin-bottom: calc(10px * var(--scale-phone)) !important;
      }
    }
    
    /* iPhone 16 Pro and larger phones (429px - 768px) */
    @media screen and (min-width: 429px) and (max-width: 768px) {
      :root {
        --scale-phone: 0.85;
        --scale-tablet: 0.9;
        --scale-desktop: 0.95;
        --scale-tv: 1;
      }
      
      body {
        font-size: calc(15px * var(--scale-phone));
        padding: calc(15px * var(--scale-phone));
      }
      
      .signup-container {
        padding: calc(30px * var(--scale-phone));
        margin: calc(15px * var(--scale-phone));
        max-width: calc(100vw - 30px);
        width: calc(100vw - 30px);
        border-radius: calc(8px * var(--scale-phone));
        box-shadow: 0 calc(4px * var(--scale-phone)) calc(6px * var(--scale-phone)) rgba(0, 0, 0, 0.1);
      }
      
      h1 {
        font-size: calc(1.5rem * var(--scale-phone));
        margin-bottom: calc(25px * var(--scale-phone));
      }
      
      .form-group {
        margin-bottom: calc(18px * var(--scale-phone));
      }
      
      label {
        font-size: calc(15px * var(--scale-phone));
        margin-bottom: calc(5px * var(--scale-phone));
      }
      
      input[type="text"], input[type="email"], input[type="password"], select {
        padding: calc(12px * var(--scale-phone));
        border-radius: calc(4px * var(--scale-phone));
        font-size: calc(15px * var(--scale-phone));
      }
      
      button[type="submit"], #continueBtn {
        padding: calc(12px * var(--scale-phone));
        border-radius: calc(4px * var(--scale-phone));
        font-size: calc(15px * var(--scale-phone));
        margin-top: calc(18px * var(--scale-phone));
      }
      
      #backToLoginBtn {
        padding: calc(10px * var(--scale-phone)) calc(20px * var(--scale-phone));
        border-radius: calc(4px * var(--scale-phone));
        font-size: calc(14px * var(--scale-phone));
      }
      
      /* Avatar grid scaling */
      #avatarGrid {
        gap: calc(12px * var(--scale-phone)) !important;
        margin-bottom: calc(10px * var(--scale-phone)) !important;
      }
      
      #avatarGrid canvas {
        width: calc(56px * var(--scale-phone)) !important;
        height: calc(56px * var(--scale-phone)) !important;
        margin: calc(3px * var(--scale-phone)) !important;
        border-radius: calc(7px * var(--scale-phone)) !important;
      }
      
      /* Desk grid scaling */
      #deskGrid table td {
        width: calc(28px * var(--scale-phone)) !important;
        height: calc(28px * var(--scale-phone)) !important;
        font-size: calc(14px * var(--scale-phone)) !important;
      }
      
      /* Label scaling for desk selection */
      label[for="deskSelection"] {
        font-size: calc(18px * var(--scale-phone)) !important;
        margin-bottom: calc(12px * var(--scale-phone)) !important;
      }
    }
    
    /* MacBook and laptop scaling (769px - 1439px) */
    @media screen and (min-width: 769px) and (max-width: 1439px) {
      :root {
        --scale-phone: 0.9;
        --scale-tablet: 0.95;
        --scale-desktop: 1;
        --scale-tv: 1.05;
      }
      
      body {
        font-size: calc(16px * var(--scale-desktop));
      }
      
      .signup-container {
        padding: calc(40px * var(--scale-desktop));
        max-width: calc(600px * var(--scale-desktop));
        border-radius: calc(8px * var(--scale-desktop));
        box-shadow: 0 calc(4px * var(--scale-desktop)) calc(6px * var(--scale-desktop)) rgba(0, 0, 0, 0.1);
      }
      
      h1 {
        font-size: calc(2rem * var(--scale-desktop));
        margin-bottom: calc(30px * var(--scale-desktop));
      }
      
      .form-group {
        margin-bottom: calc(20px * var(--scale-desktop));
      }
      
      label {
        font-size: calc(16px * var(--scale-desktop));
        margin-bottom: calc(5px * var(--scale-desktop));
      }
      
      input[type="text"], input[type="email"], input[type="password"], select {
        padding: calc(12px * var(--scale-desktop));
        border-radius: calc(4px * var(--scale-desktop));
        font-size: calc(16px * var(--scale-desktop));
      }
      
      button[type="submit"], #continueBtn {
        padding: calc(12px * var(--scale-desktop));
        border-radius: calc(4px * var(--scale-desktop));
        font-size: calc(16px * var(--scale-desktop));
        margin-top: calc(20px * var(--scale-desktop));
      }
      
      #backToLoginBtn {
        padding: calc(10px * var(--scale-desktop)) calc(20px * var(--scale-desktop));
        border-radius: calc(4px * var(--scale-desktop));
        font-size: calc(14px * var(--scale-desktop));
      }
      
      /* Avatar grid scaling */
      #avatarGrid {
        gap: calc(16px * var(--scale-desktop)) !important;
        margin-bottom: calc(10px * var(--scale-desktop)) !important;
      }
      
      #avatarGrid canvas {
        width: calc(64px * var(--scale-desktop)) !important;
        height: calc(64px * var(--scale-desktop)) !important;
        margin: calc(4px * var(--scale-desktop)) !important;
        border-radius: calc(8px * var(--scale-desktop)) !important;
      }
      
      /* Desk grid scaling */
      #deskGrid table td {
        width: calc(36px * var(--scale-desktop)) !important;
        height: calc(36px * var(--scale-desktop)) !important;
        font-size: calc(16px * var(--scale-desktop)) !important;
      }
      
      /* Label scaling for desk selection */
      label[for="deskSelection"] {
        font-size: calc(18px * var(--scale-desktop)) !important;
        margin-bottom: calc(15px * var(--scale-desktop)) !important;
      }
    }
    
    /* Desktop monitors (1440px and up) */
    @media screen and (min-width: 1440px) {
      :root {
        --scale-phone: 1;
        --scale-tablet: 1.05;
        --scale-desktop: 1.1;
        --scale-tv: 1.2;
      }
      
      body {
        font-size: calc(16px * var(--scale-desktop));
      }
      
      .signup-container {
        padding: calc(50px * var(--scale-desktop));
        max-width: calc(700px * var(--scale-desktop));
        border-radius: calc(10px * var(--scale-desktop));
        box-shadow: 0 calc(6px * var(--scale-desktop)) calc(12px * var(--scale-desktop)) rgba(0, 0, 0, 0.15);
      }
      
      h1 {
        font-size: calc(2rem * var(--scale-desktop));
        margin-bottom: calc(35px * var(--scale-desktop));
      }
      
      .form-group {
        margin-bottom: calc(25px * var(--scale-desktop));
      }
      
      label {
        font-size: calc(16px * var(--scale-desktop));
        margin-bottom: calc(6px * var(--scale-desktop));
      }
      
      input[type="text"], input[type="email"], input[type="password"], select {
        padding: calc(15px * var(--scale-desktop));
        border-radius: calc(6px * var(--scale-desktop));
        font-size: calc(16px * var(--scale-desktop));
      }
      
      button[type="submit"], #continueBtn {
        padding: calc(15px * var(--scale-desktop));
        border-radius: calc(6px * var(--scale-desktop));
        font-size: calc(16px * var(--scale-desktop));
        margin-top: calc(25px * var(--scale-desktop));
      }
      
      #backToLoginBtn {
        padding: calc(12px * var(--scale-desktop)) calc(24px * var(--scale-desktop));
        border-radius: calc(6px * var(--scale-desktop));
        font-size: calc(15px * var(--scale-desktop));
      }
      
      /* Avatar grid scaling */
      #avatarGrid {
        gap: calc(20px * var(--scale-desktop)) !important;
        margin-bottom: calc(15px * var(--scale-desktop)) !important;
      }
      
      #avatarGrid canvas {
        width: calc(72px * var(--scale-desktop)) !important;
        height: calc(72px * var(--scale-desktop)) !important;
        margin: calc(5px * var(--scale-desktop)) !important;
        border-radius: calc(10px * var(--scale-desktop)) !important;
      }
      
      /* Desk grid scaling */
      #deskGrid table td {
        width: calc(40px * var(--scale-desktop)) !important;
        height: calc(40px * var(--scale-desktop)) !important;
        font-size: calc(18px * var(--scale-desktop)) !important;
      }
      
      /* Label scaling for desk selection */
      label[for="deskSelection"] {
        font-size: calc(20px * var(--scale-desktop)) !important;
        margin-bottom: calc(20px * var(--scale-desktop)) !important;
      }
    }
  </style>
</head>
<body>
  <div class="signup-container">
    <h1>Sign Up</h1>
    
    <!-- Step 1: Basic Information -->
    <form id="signupForm">
      <div class="form-group">
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" required>
      </div>
      <div class="form-group">
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>
      </div>
      <div class="form-group">
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required>
      </div>
      <div class="form-group">
        <label for="roomCode">Room Code:</label>
        <input type="text" id="roomCode" name="roomCode" required>
      </div>
      <div class="form-group">
        <label for="role">Role:</label>
        <select id="role" name="role" required>
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="form-group" id="adminCodeGroup" style="display: none;">
        <label for="adminCode">Admin Code:</label>
        <input type="password" id="adminCode" name="adminCode">
      </div>
      <div class="form-group">
        <label>Select Your Avatar:</label>
        <div id="avatarGrid" style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; margin-bottom: 10px;"></div>
        <input type="hidden" name="avatar" id="avatarSelection" required>
      </div>
      <div class="form-group">
        <label style="font-size: 18px; font-weight: bold; color: #333; margin-bottom: 15px;">Choose Desk:</label>
        <div id="deskGrid" style="margin: 20px 0;"></div>
      </div>
      <input type="hidden" name="deskSelection" id="deskSelection">
    <div id="selectedDeskDisplay" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
      <strong>Selected Desk:</strong> <span id="selectedDeskText"></span>
    </div>
      <button type="submit">Sign Up</button>
    </form>
    
    <div style="margin-top: 20px; text-align: center;">
      <button id="backToLoginBtn" style="background-color: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background-color 0.3s;">
        ← Back to Login
      </button>
    </div>
    
    <div id="message" style="margin-top:20px;"></div>
  </div>
  
  <script>
    const DESK_IDS = ["desk1", "desk2", "desk3", "desk4", "desk5", "desk6"];

    // Updated desk layout configuration to match board.html
    // New layout includes rotated desks and different desk types
    const gridCols = 17;
    const gridRows = 11;
    const deskPositions = [
      // Buddies Row 0: xoxox
      {x:2.7, y:1, rotation: 0, deskType: 'desk'}, {x:5, y:1.3, rotation: 0, deskType: 'desk'},
      // Row 1: oxxx
      {x:0.9, y:2.5, rotation: 0, deskType: 'desk'},
      // Row 2: oxxoxxxo
      {x:0.9, y:3.7, rotation: 0, deskType: 'desk'}, {x:4.2, y:3.4, rotation: 0, deskType: 'deskop'}, {x:8, y:4, rotation: 0, deskType: 'deskop'},
      // Row 3: xxxxxxxxxxoxxoxxo
      {x:2.1, y:7.7, rotation: -45, deskType: 'desk'}, {x:2.6, y:8.2, rotation: -45, deskType: 'desk'}, 

      {x:5.1, y:8.4, rotation: 0, deskType: 'deskop'}, {x:5.1, y:9.1, rotation: 0, deskType: 'deskop'}, {x:4.3, y:9.1, rotation: 0, deskType: 'desk'}, {x:4.3, y:8.4, rotation: 0, deskType: 'desk'},  
      
      {x:7.5, y:8.2, rotation: 0, deskType: 'deskop'}, {x:7.5, y:8.9, rotation: 0, deskType: 'deskop'}, {x:6.7, y:8.2, rotation: 0, deskType: 'desk'}, {x:6.7, y:8.9, rotation: 0, deskType: 'desk'},

      {x:10.1, y:8.4, rotation: 0, deskType: 'deskop'}, {x:10.1, y:9.1, rotation: 0, deskType: 'deskop'}, {x:9.3, y:9.1, rotation: 0, deskType: 'desk'}, {x:9.3, y:8.4, rotation: 0, deskType: 'desk'},

      {x:12.2, y:8.5, rotation: 0, deskType: 'deskop'}, {x:12.2, y:9.2, rotation: 0, deskType: 'deskop'}, {x:11.4, y:8.5, rotation: 0, deskType: 'desk'}, {x:11.4, y:9.2, rotation: 0, deskType: 'desk'},
      
      {x:14.35, y:8.2, rotation: 0, deskType: 'deskop'}, {x:14.35, y:8.9, rotation: 0, deskType: 'deskop'}, {x:13.6, y:8.2, rotation: 0, deskType: 'desk'}, {x:13.6, y:8.9, rotation: 0, deskType: 'desk'},

      {x:15.5, y:7.6, rotation: 0, deskType: 'desk'}, {x:15.5, y:9.3, rotation: 0, deskType: 'desk'},
      // Row 4: oxxxx
      {x:11, y:6.1, rotation: 0, deskType: 'desk'}, {x:12.2, y:6.1, rotation: 0, deskType: 'desk'},{x:13.5, y:6.1, rotation: 0, deskType: 'desk'},
    ];

    // Wait for DOM to be ready and ApiUrlLink to be available
    document.addEventListener('DOMContentLoaded', function() {
      // Show/hide admin code field based on role selection
      document.getElementById('role').addEventListener('change', function() {
        const adminCodeGroup = document.getElementById('adminCodeGroup');
        if (this.value === 'admin') {
          adminCodeGroup.style.display = 'block';
        } else {
          adminCodeGroup.style.display = 'none';
        }
      });

      // Back to login button handler
      document.getElementById('backToLoginBtn').addEventListener('click', function() {
        window.location.href = 'index.html';
      });
      
      // Replace the form submission handler with this:
      document.getElementById('signupForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const room_code = document.getElementById('roomCode').value.trim();
        const role = document.getElementById('role').value;
        const admin_code = document.getElementById('adminCode').value;
        const deskSelection = document.getElementById('deskSelection').value;
        const avatar = document.getElementById('avatarSelection').value;
        if (room_code !== "ElenConsulting100") {
          alert("Invalid room code");
          return;
        }
        if (role === 'admin' && !admin_code) {
          alert('Please enter the admin code.');
          return;
        }
        if (!deskSelection) {
          alert('Please select a desk.');
          return;
        }
        if (!avatar) {
          alert('Please select an avatar.');
          return;
        }
        const payload = {
          username,
          email,
          password,
          room_code,
          role,
          deskSelection,
          avatar,
          status: "clocked-out" // Set initial status to clocked-out
        };
        if (role === 'admin') {
          payload.admin_code = admin_code;
        }
        const res = await fetch(`${ApiUrlLink}/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (res.ok) {
          alert('Signup successful! Please log in.');
          window.location.href = 'index.html';
        } else {
          alert(data.error || 'Signup failed');
        }
      });

      // Fetch taken desks from backend and render the grid
      fetch(`${ApiUrlLink}/users`)
        .then(res => res.json())
        .then(data => {
          console.log("Fetched users:", data);  // Check what comes back
          if (!data.users) {
            console.warn("No users returned from backend");
            return;
          }
          const takenDesks = new Set(data.users.map(u => u.desk));
          renderDeskGrid(takenDesks);
        })
        .catch(err => {
          console.error('Error fetching desks:', err);
          document.getElementById('deskGrid').innerText = 'Unable to load desk layout.';
        });

      // Call renderAvatarGrid after DOM is loaded and base is available
      renderAvatarGrid();
    });


    
    function renderDeskGrid(takenDesks) {
      const grid = document.getElementById('deskGrid');
      grid.innerHTML = '';
      
      // Create canvas for desk selection (similar to board.html)
      const canvas = document.createElement('canvas');
      canvas.width = 1100; // Match board.html dimensions
      canvas.height = 700;
      canvas.style.border = '2px solid #333';
      canvas.style.borderRadius = '8px';
      canvas.style.cursor = 'pointer';
      canvas.style.maxWidth = '100%';
      canvas.style.height = 'auto';
      
      const ctx = canvas.getContext('2d');
      
      // Add click event listener immediately
      canvas.addEventListener('click', function(e) {
        handleDeskClick(e, ctx, canvas, takenDesks);
      });
      
      // Add test click for debugging (click anywhere to see coordinates)
      canvas.addEventListener('mousemove', function(e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        canvas.title = `Mouse at: (${x.toFixed(1)}, ${y.toFixed(1)})`;
      });
      
      // Load background image
      const layoutImg = new Image();
      layoutImg.onload = function() {
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw background layout
        ctx.save();
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(-Math.PI / 2);
        
        const baseScale = Math.min(canvas.width / layoutImg.height, canvas.height / layoutImg.width);
        const scale = baseScale * 1.2;
        const scaledWidth = layoutImg.width * scale;
        const scaledHeight = layoutImg.height * scale;
        
        ctx.drawImage(layoutImg, -scaledWidth / 2, -scaledHeight / 2, scaledWidth, scaledHeight);
        ctx.restore();
        
        // Draw grid
        drawGrid(ctx, canvas.width, canvas.height);
        
        // Draw desks
        drawDesks(ctx, takenDesks);
        
        // Store context and canvas for click handling
        canvas.dataset.ctx = ctx;
        canvas.dataset.takenDesks = JSON.stringify(Array.from(takenDesks));
      };
      layoutImg.src = `${document.baseURI}Static/Images/Background/newbackground.png`;
      
      grid.appendChild(canvas);
      
      // Add legend
      const legend = document.createElement('div');
      legend.style.marginTop = '10px';
      legend.style.textAlign = 'center';
      legend.style.fontSize = '14px';
      legend.innerHTML = `
        <div style="display: inline-block; margin: 0 10px;">
          <span style="display: inline-block; width: 20px; height: 20px; background: #e0f7fa; border: 2px solid #28a745; vertical-align: middle; margin-right: 5px;"></span>
          Available Desk
        </div>
        <div style="display: inline-block; margin: 0 10px;">
          <span style="display: inline-block; width: 20px; height: 20px; background: #ccc; border: 1px solid #999; vertical-align: middle; margin-right: 5px;"></span>
          Occupied Desk
        </div>
      `;
      grid.appendChild(legend);
    }
    
    function drawGrid(ctx, width, height) {
      const gridSize = 64; // Match board.html grid size
      const gridColor = 'rgba(255, 255, 255, 0.4)';
      
      ctx.save();
      ctx.strokeStyle = gridColor;
      ctx.lineWidth = 1;
      
      for (let x = 0; x <= width; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
      }
      
      for (let y = 0; y <= height; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
      }
      
      ctx.restore();
    }
    
    function drawDesks(ctx, takenDesks) {
      const cellSize = 64; // Match board.html grid size
      
      deskPositions.forEach((desk, index) => {
        const x = desk.x * cellSize;
        const y = desk.y * cellSize;
        
        ctx.save();
        
        // Move to desk center for rotation
        ctx.translate(x + cellSize/2, y + cellSize/2);
        
        // Apply rotation if specified
        if (desk.rotation !== undefined && desk.rotation !== 0) {
          ctx.rotate(desk.rotation * Math.PI / 180);
        }
        
        // Check if desk is taken
        const deskKey = `${desk.x},${desk.y}`;
        const isTaken = takenDesks.has(deskKey);
        
        // Draw desk rectangle
        const deskSize = cellSize * 0.8;
        ctx.fillStyle = isTaken ? '#ccc' : '#e0f7fa';
        ctx.strokeStyle = isTaken ? '#999' : '#007bff';
        ctx.lineWidth = isTaken ? 1 : 3; // Thicker border for available desks
        
        ctx.fillRect(-deskSize/2, -deskSize/2, deskSize, deskSize);
        ctx.strokeRect(-deskSize/2, -deskSize/2, deskSize, deskSize);
        
        // Add hover effect for available desks
        if (!isTaken) {
          ctx.strokeStyle = '#28a745'; // Green border for available desks
          ctx.lineWidth = 2;
          ctx.strokeRect(-deskSize/2, -deskSize/2, deskSize, deskSize);
        }
        
        // Add desk number
        ctx.fillStyle = '#333';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText((index + 1).toString(), 0, 4);
        
        // Debug: Draw clickable area outline (semi-transparent)
        if (!isTaken) {
          ctx.strokeStyle = 'rgba(255, 0, 0, 0.3)'; // Semi-transparent red
          ctx.lineWidth = 1;
          ctx.strokeRect(-deskSize/2, -deskSize/2, deskSize, deskSize);
          

        }
        

        
        ctx.restore();
      });
    }
    
    function drawClickMarker(ctx, x, y) {
      // Draw a red cross at the click position for debugging
      ctx.save();
      ctx.strokeStyle = 'red';
      ctx.lineWidth = 3;
      
      // Draw horizontal line
      ctx.beginPath();
      ctx.moveTo(x - 10, y);
      ctx.lineTo(x + 10, y);
      ctx.stroke();
      
      // Draw vertical line
      ctx.beginPath();
      ctx.moveTo(x, y - 10);
      ctx.lineTo(x, y + 10);
      ctx.stroke();
      
      ctx.restore();
    }
    
    function handleDeskClick(e, ctx, canvas, takenDesks) {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (canvas.width / rect.width);
      const y = (e.clientY - rect.top) * (canvas.height / rect.height);
      
      console.log('Raw click coordinates:', e.clientX, e.clientY);
      console.log('Canvas rect:', rect.left, rect.top, rect.width, rect.height);
      console.log('Canvas dimensions:', canvas.width, canvas.height);
      console.log('Calculated canvas coordinates:', x, y);
      
      const cellSize = 64; // Match board.html grid size
      let deskSelected = false;
      
      // Check if click is on a desk
      for (let i = 0; i < deskPositions.length; i++) {
        const desk = deskPositions[i];
        // Use the exact same positioning logic as drawDesks function
        const deskX = desk.x * cellSize;
        const deskY = desk.y * cellSize;
        const deskSize = cellSize * 0.8;
        
        const deskCenterX = deskX + cellSize/2;
        const deskCenterY = deskY + cellSize/2;
        const halfDeskSize = deskSize/2;
        
        console.log(`Checking desk ${i + 1} at (${desk.x}, ${desk.y}) - canvas pos (${deskX}, ${deskY})`);
        console.log(`Desk center: (${deskCenterX}, ${deskCenterY}), half size: ${halfDeskSize}`);
        console.log(`Click at (${x}, ${y}) - Desk bounds: x(${deskCenterX - halfDeskSize}, ${deskCenterX + halfDeskSize}), y(${deskCenterY - halfDeskSize}, ${deskCenterY + halfDeskSize})`);
        
        // Check if click is within the desk bounds (same as visual display)
        // The desks are drawn with ctx.translate(x + cellSize/2, y + cellSize/2) and then drawn from -deskSize/2 to +deskSize/2
        // So the actual visual bounds are from (deskX + cellSize/2 - deskSize/2) to (deskX + cellSize/2 + deskSize/2)
        if (x >= deskCenterX - halfDeskSize && x <= deskCenterX + halfDeskSize &&
            y >= deskCenterY - halfDeskSize && y <= deskCenterY + halfDeskSize) {
          
          const deskKey = `${desk.x},${desk.y}`;
          const isTaken = takenDesks.has(deskKey);
          
          if (!isTaken) {
            console.log(`Desk ${i + 1} selected!`);
            deskSelected = true;
            
            // Select this desk
            document.getElementById('deskSelection').value = deskKey;
            
            // Show selected desk information
            const selectedDeskDisplay = document.getElementById('selectedDeskDisplay');
            const selectedDeskText = document.getElementById('selectedDeskText');
            selectedDeskText.textContent = `Desk ${i + 1} at position (${desk.x.toFixed(1)}, ${desk.y.toFixed(1)})`;
            selectedDeskDisplay.style.display = 'block';
            
                    // Redraw to highlight selected desk
        redrawCanvas(ctx, canvas, takenDesks, deskKey);
        break; // Exit loop once desk is found
      } else {
        console.log(`Desk ${i + 1} is already taken`);
        alert(`Desk ${i + 1} is already occupied. Please choose another desk.`);
      }
    }
  }
  
  if (!deskSelected) {
    console.log('Click was not on any desk');
    // Draw click marker for debugging
    drawClickMarker(ctx, x, y);
    // Removed alert - just log to console for debugging
  }
}
    
    function redrawCanvas(ctx, canvas, takenDesks, selectedDeskKey) {
      // Clear and redraw with selected desk highlighted
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Redraw background
      const layoutImg = new Image();
      layoutImg.onload = function() {
        ctx.save();
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(-Math.PI / 2);
        
        const baseScale = Math.min(canvas.width / layoutImg.height, canvas.height / layoutImg.width);
        const scale = baseScale * 1.2;
        const scaledWidth = layoutImg.width * scale;
        const scaledHeight = layoutImg.height * scale;
        
        ctx.drawImage(layoutImg, -scaledWidth / 2, -scaledHeight / 2, scaledWidth, scaledHeight);
        ctx.restore();
        
        drawGrid(ctx, canvas.width, canvas.height);
        drawDesks(ctx, takenDesks);
        
        // Highlight selected desk
        if (selectedDeskKey) {
          const selectedDesk = deskPositions.find(d => `${d.x},${d.y}` === selectedDeskKey);
          if (selectedDesk) {
            const index = deskPositions.indexOf(selectedDesk);
            const x = selectedDesk.x * 64;
            const y = selectedDesk.y * 64;
            const deskSize = 64 * 0.8;
            
            ctx.save();
            // Use exact same positioning as drawDesks function
            ctx.translate(x + 64/2, y + 64/2);
            if (selectedDesk.rotation !== undefined && selectedDesk.rotation !== 0) {
              ctx.rotate(selectedDesk.rotation * Math.PI / 180);
            }
            
                      ctx.strokeStyle = '#28a745'; // Green color to match selection theme
          ctx.lineWidth = 4;
          ctx.strokeRect(-deskSize/2, -deskSize/2, deskSize, deskSize);
            ctx.restore();
          }
        }
      };
      layoutImg.src = `${document.baseURI}Static/Images/Background/newbackground.png`;
    }

    const avatarConfigs = {
      "City_men_idle.png": {
        frameWidth: 128,
        frameHeight: 128,
        totalFrames: 6,
        frameDuration: 200
      },
      "Boy_idle.png": {
        frameWidth: 48,
        frameHeight: 48,
        totalFrames: 4,
        frameDuration: 200
      }
    };

    const avatars = [
      { name: "City Men", file: "City_men_idle.png" },
      { name: "Boy", file: "Boy_idle.png" }
    ];

    const AVATAR_BOX_SIZE = 64; // The size of the selection box

    function renderAvatarGrid() {
      const grid = document.getElementById('avatarGrid');
      grid.innerHTML = '';
      avatars.forEach((avatar, idx) => {
        const config = avatarConfigs[avatar.file];
        const canvas = document.createElement('canvas');
        canvas.width = AVATAR_BOX_SIZE;
        canvas.height = AVATAR_BOX_SIZE;
        canvas.style.borderRadius = '8px';
        canvas.style.border = '2px solid transparent';
        canvas.style.cursor = 'pointer';
        canvas.style.background = '#f8f9fa';
        canvas.title = avatar.name;
        canvas.dataset.avatarFile = avatar.file;
        canvas.style.margin = '4px';

        // Animation state for each avatar
        let frameIndex = 0;
        let lastFrameTime = 0;
        const spriteSheet = new window.Image();
        spriteSheet.src = `${base.href}Static/Images/Characters/${avatar.file}`;

        // Calculate scale to fit the frame in the box
        const scale = Math.min(
          AVATAR_BOX_SIZE / config.frameWidth,
          AVATAR_BOX_SIZE / config.frameHeight
        );
        const drawWidth = config.frameWidth * scale;
        const drawHeight = config.frameHeight * scale;
        const offsetX = (AVATAR_BOX_SIZE - drawWidth) / 2;
        const offsetY = (AVATAR_BOX_SIZE - drawHeight) / 2;

        function animateAvatar(ts) {
          if (!lastFrameTime) lastFrameTime = ts;
          const elapsed = ts - lastFrameTime;
          if (elapsed > config.frameDuration) {
            frameIndex = (frameIndex + 1) % config.totalFrames;
            lastFrameTime = ts;
          }
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(
            spriteSheet,
            frameIndex * config.frameWidth, 0, config.frameWidth, config.frameHeight,
            offsetX, offsetY, drawWidth, drawHeight
          );
          requestAnimationFrame(animateAvatar);
        }
        spriteSheet.onload = () => requestAnimationFrame(animateAvatar);

        canvas.onclick = () => {
          document.getElementById('avatarSelection').value = avatar.file;
          Array.from(grid.children).forEach(child => child.style.border = '2px solid transparent');
          canvas.style.border = '2px solid #007bff';
        };

        grid.appendChild(canvas);
      });
    }
  </script>
</body>
</html>
