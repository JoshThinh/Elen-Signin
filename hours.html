<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Weekly Hours</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css?family=Quicksand:400,500,700&display=swap" rel="stylesheet">
  <script src="config.js" defer></script>
  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const base = document.createElement('base');
      base.href = location.hostname === 'localhost' ? '/' : 'https://joshthinh.github.io/Elen-Signin/';
      document.head.appendChild(base);
  
      // Ensure config.js is loaded before accessing API_URL / API_URL_DEPLOYED
      if (typeof API_URL === 'undefined' || typeof API_URL_DEPLOYED === 'undefined') {
        console.error('API_URL or API_URL_DEPLOYED is not defined. Check config.js loading.');
        return;
      }
  
      window.ApiUrlLink = location.hostname === 'localhost' ? API_URL : API_URL_DEPLOYED;
  
      // Continue rest of logic here if needed
    });
  </script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      font-family: 'Crimson Text', serif;
      font-size: 16px;
      color: #777777;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding-top: 56px; /* Prevent content from being hidden under navbar */
    }
    
    .hours-container {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      text-align: center;
      max-width: 1200px;
      width: 100%;
    }
    
    .navbar {
      width: 100%;
      height: 60px;
      background: #2d2e4bf2;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1001;
      box-sizing: border-box;
      padding-right: 8px;
      transition: background 0.4s;
    }
    
    .navbar-hamburger {
      font-size: 2rem;
      cursor: pointer;
      padding: 0 24px;
      user-select: none;
    }
    
    .navbar-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin-left: 12px;
    }
    
    .sidebar {
      position: fixed;
      top: 0;
      right: -220px;
      width: 220px;
      height: 100%;
      background: #2d2e4bf2;
      color: rgba(45, 46, 75, 0.95);
      display: flex;
      flex-direction: column;
      padding-top: 56px;
      transition: right 0.3s;
      z-index: 1002;
    }
    
    .sidebar.open {
      right: 0;
    }
    
    .sidebar a {
      color: #DDDDDD;
      padding: 18px 24px;
      text-decoration: none;
      font-size: 1.1rem;
      border-bottom: 1px solid #444;
      transition: background 0.2s;
    }
    
    .sidebar a:hover {
      background: rgba(45, 46, 75, 0.8);
      color: #fff;
    }
    
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 1000;
    }
    
    .sidebar-overlay.open {
      display: block;
    }
    
    h1 {
      margin-bottom: 30px;
      color: #333;
      font-size: 2rem;
      font-weight: bold;
      text-align: center;
    }
    
    h2 {
      margin-bottom: 20px;
      color: #333;
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .refresh-indicator {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin: 10px 0;
    }
    
    .refreshing {
      color: #2d2e4b;
      font-weight: bold;
    }
    
    .last-updated {
      color: #333;
    }
    
    .user-hours-section {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      padding: 20px;
      text-align: left;
    }
    
    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .user-name {
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
    }
    
    .user-status {
      font-size: 0.9rem;
      padding: 4px 8px;
      border-radius: 4px;
      color: white;
    }
    
    .status-active {
      background: #2d2e4b;
    }
    
    .status-inactive {
      background: #6c757d;
    }
    
    .days-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
    }
    
    .day-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      border: 2px solid #e0e0e0;
      position: relative;
      transition: border-color 0.3s;
    }
    
    .day-card:hover {
      border-color: #2d2e4b;
    }
    
    .day-header {
      font-size: 0.9rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    
    .hours-display {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .hour-card {
      text-align: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 3px solid;
    }
    
    .work-hours {
      border-left-color: #2d2e4b;
    }
    
    .break-hours {
      border-left-color: #6c757d;
    }
    
    .hour-label {
      font-size: 0.8rem;
      color: #333;
      margin-bottom: 3px;
    }
    
    .hour-value {
      font-size: 1.1rem;
      font-weight: bold;
      color: #333;
    }
    
    .work-hours .hour-value {
      color: #2d2e4b;
    }
    
    .break-hours .hour-value {
      color: #6c757d;
    }
    
    .today-indicator {
      background: #e8e9f0;
      border: 2px solid #2d2e4b;
    }
    
    .real-time-indicator {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #2d2e4b;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
    }
    .hours-container {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <span class="navbar-title">Weekly Hours - <span id="userDisplay"></span></span>
    <span class="navbar-hamburger" onclick="toggleSidebar()">&#9776;</span>
  </nav>
  <div class="sidebar" id="sidebar">
    <a href="#" id="dashboardLink">Dashboard</a>
    <a href="#" id="boardLink">Board</a>
    <a href="#" id="settingsLink">Settings</a>
    <a href="#" id="submitLink">Submit Email</a>
    <a href="#" id="viewEmailLink">View Email</a>
    <a href="#" style="display:none;">Hours</a>
    <a href="#" id="editUsersLink">Edit Users</a>
    <a href="#" onclick="signOut()">Sign Out</a>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
  
  <div class="hours-container">
    <h1>Weekly Hours (Mon-Fri)</h1>
    <div class="refresh-indicator" id="refreshIndicator">
      Auto-refreshing every 30 seconds.
    </div>
    <div id="hoursContainer"></div>
  </div>
  
  <script>
    // Function to convert decimal hours to HH:MM format
    function formatHours(hours) {
      const totalMinutes = Math.round(hours * 60);
      const h = Math.floor(totalMinutes / 60);
      const m = totalMinutes % 60;
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }

    // Function to update the refresh indicator
    function updateRefreshIndicator(message, className = '') {
      const indicator = document.getElementById('refreshIndicator');
      indicator.textContent = message;
      indicator.className = `refresh-indicator ${className}`;
    }

    // Function to get day name from date
    function getDayName(dateString) {
      // Always parse as local midnight to avoid timezone issues
      const date = new Date(dateString + 'T00:00:00');
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      return days[date.getDay()];
    }

    // Function to load and display hours data
    function loadHoursData() {
      updateRefreshIndicator('Refreshing data...', 'refreshing');
      
          // Fetch both weekly timesheets and current hours
    Promise.all([
      fetch(`${window.ApiUrlLink}/weekly_timesheets`).then(res => res.json()),
      fetch(`${window.ApiUrlLink}/current_hours`).then(res => res.json())
    ]).then(([weekData, currentData]) => {
        console.log('Weekly data:', weekData);
        console.log('Current hours data:', currentData);
        
        const today = new Date().toISOString().slice(0, 10);
        console.log('Today\'s date:', today);
        
        const currentMap = {};
        currentData.forEach(u => currentMap[u.username] = u);
        console.log('Current hours map:', currentMap);

        const container = document.getElementById('hoursContainer');
        container.innerHTML = ''; // Clear existing data
        
        weekData.users.forEach(user => {
          const userSection = document.createElement('div');
          userSection.className = 'user-hours-section';
          
          // User header with status
          const userHeader = document.createElement('div');
          userHeader.className = 'user-header';
          
          const userName = document.createElement('div');
          userName.className = 'user-name';
          userName.textContent = user.username;
          
          const userStatus = document.createElement('div');
          const hasCurrentData = currentMap[user.username];
          const isActive = hasCurrentData && (currentMap[user.username].status === "clocked-in" || currentMap[user.username].status === "break");
          userStatus.className = `user-status ${isActive ? 'status-active' : 'status-inactive'}`;
          userStatus.textContent = isActive ? 'Active' : 'Inactive';
          
          userHeader.appendChild(userName);
          userHeader.appendChild(userStatus);
          userSection.appendChild(userHeader);
          
          // Days grid
          const daysGrid = document.createElement('div');
          daysGrid.className = 'days-grid';
          
          user.days.forEach((day, i) => {
            const dayCard = document.createElement('div');
            const dayDate = weekData.week_dates[i];
            const isToday = dayDate === today;
            const isActive = hasCurrentData && (currentMap[user.username].status === "clocked-in" || currentMap[user.username].status === "break");
            
            dayCard.className = `day-card ${isToday ? 'today-indicator' : ''}`;
            
            // Day header
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header';
            dayHeader.textContent = getDayName(dayDate);
            dayCard.appendChild(dayHeader);
            
            // Hours display
            const hoursDisplay = document.createElement('div');
            hoursDisplay.className = 'hours-display';
            
            // Work hours
            const workHoursCard = document.createElement('div');
            workHoursCard.className = 'hour-card work-hours';
            
            const workLabel = document.createElement('div');
            workLabel.className = 'hour-label';
            workLabel.textContent = 'Work';
            
            const workValue = document.createElement('div');
            workValue.className = 'hour-value';
            
            // Break hours
            const breakHoursCard = document.createElement('div');
            breakHoursCard.className = 'hour-card break-hours';
            
            const breakLabel = document.createElement('div');
            breakLabel.className = 'hour-label';
            breakLabel.textContent = 'Break';
            
            const breakValue = document.createElement('div');
            breakValue.className = 'hour-value';
            
            // If this is today, and user is clocked in or on break, use real-time hours
            if (isToday && hasCurrentData && isActive) {
              const workHours = formatHours(Number(currentMap[user.username].work_hours));
              const breakHours = formatHours(Number(currentMap[user.username].break_hours));
              console.log(`Using real-time hours for ${user.username}: Work=${workHours}, Break=${breakHours}`);
              workValue.textContent = workHours;
              breakValue.textContent = breakHours;
              
              // Add real-time indicator
              const realTimeIndicator = document.createElement('div');
              realTimeIndicator.className = 'real-time-indicator';
              realTimeIndicator.textContent = 'L';
              dayCard.appendChild(realTimeIndicator);
            } else {
              const workHours = formatHours(Number(day.work_hours));
              const breakHours = formatHours(Number(day.break_hours));
              console.log(`Using saved hours for ${user.username}: Work=${workHours}, Break=${breakHours}`);
              workValue.textContent = workHours;
              breakValue.textContent = breakHours;
            }
            
            workHoursCard.appendChild(workLabel);
            workHoursCard.appendChild(workValue);
            breakHoursCard.appendChild(breakLabel);
            breakHoursCard.appendChild(breakValue);
            
            hoursDisplay.appendChild(workHoursCard);
            hoursDisplay.appendChild(breakHoursCard);
            dayCard.appendChild(hoursDisplay);
            daysGrid.appendChild(dayCard);
          });
          
          userSection.appendChild(daysGrid);
          container.appendChild(userSection);
        });
        
        // Update refresh indicator with last updated time
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        updateRefreshIndicator(`Last updated: ${timeString} | Auto-refreshing every 30 seconds...`, 'last-updated');
        
      }).catch(error => {
        console.error('Error fetching hours data:', error);
        document.getElementById('hoursContainer').innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">Error loading hours data</div>';
        updateRefreshIndicator('Error loading data. Retrying in 30 seconds...', '');
      });
    }

    // Navbar and sidebar functions
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('open');
    }
    
    function signOut() {
      localStorage.removeItem('user');
      window.location.href = 'index.html';
    }
    
    // Get username from URL query parameter
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }
    
    const username = getQueryParam('username');
    
    // Wait for DOM and config to be loaded before making API calls
    document.addEventListener('DOMContentLoaded', function() {
      // Ensure config.js is loaded and ApiUrlLink is set
      if (typeof window.ApiUrlLink === 'undefined') {
        console.error('ApiUrlLink is not defined. Check config.js loading.');
        return;
      }

      if (!username) {
        window.location.href = "index.html";
        return;
      }

      fetch(`${window.ApiUrlLink}/user/${username}`)
        .then(res => {
          if (!res.ok) {
            if (res.status === 404) {
              // User not found (deleted)
              alert('Your account has been deleted. You will be redirected to the login page.');
              localStorage.removeItem('user');
              window.location.href = "index.html";
              return;
            }
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(user => {
          if (!user) return; // User was deleted, already redirected
          
          // Check if user is admin
          if (user.role !== "admin") {
            alert('Access Denied. Admin privileges required to view hours.');
            window.location.href = `dashboard.html?username=${encodeURIComponent(username)}`;
            return;
          }
          
          document.getElementById('userDisplay').textContent = user.username;
          
          // Update sidebar links to include username
          if (username) {
            document.getElementById('dashboardLink').href = `dashboard.html?username=${encodeURIComponent(username)}`;
            document.getElementById('boardLink').href = `board.html?username=${encodeURIComponent(username)}`;
            document.getElementById('settingsLink').href = `settings.html?username=${encodeURIComponent(username)}`;
            document.getElementById('submitLink').href = `submit_email.html?username=${encodeURIComponent(username)}`;
            document.getElementById('viewEmailLink').href = `view_email.html?username=${encodeURIComponent(username)}`;
            document.getElementById('editUsersLink').href = `users.html?username=${encodeURIComponent(username)}`;
          }
          
          // Initial load
          loadHoursData();

          // Set up auto-refresh every 30 seconds
          const refreshInterval = setInterval(loadHoursData, 30000); // 30 seconds

          // Clean up interval when page is unloaded
          window.addEventListener('beforeunload', () => {
            clearInterval(refreshInterval);
          });
        })
        .catch((error) => {
          console.error('Error validating user:', error);
          alert('Error validating your account. Please log in again.');
          localStorage.removeItem('user');
          window.location.href = "index.html";
        });
    });
       </script>
  </body>
  </html>
