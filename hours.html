<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Weekly Hours</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="config.js" defer></script>
  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const base = document.createElement('base');
      base.href = location.hostname === 'localhost' ? '/' : 'https://joshthinh.github.io/Elen-Signin/';
      document.head.appendChild(base);
  
      // Ensure config.js is loaded before accessing API_URL / API_URL_DEPLOYED
      if (typeof API_URL === 'undefined' || typeof API_URL_DEPLOYED === 'undefined') {
        console.error('API_URL or API_URL_DEPLOYED is not defined. Check config.js loading.');
        return;
      }
  
      window.ApiUrlLink = location.hostname === 'localhost' ? API_URL : API_URL_DEPLOYED;
  
      // Continue rest of logic here if needed
    });
  </script>
  <style>
    /* Responsive scaling variables */
    :root {
      --scale-phone: 0.8;
      --scale-tablet: 0.9;
      --scale-desktop: 1;
      --scale-tv: 1.1;
    }
    
    /* Global viewport control */
    * {
      box-sizing: border-box;
    }
    
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 16px;
      color: white;
      background: #2d2e4bf2;
      padding-left: 100px; /* Prevent content from being hidden under sidebar */
      overflow-x: hidden !important;
      max-width: 100vw !important;
      width: 100vw !important;
    }
    
    .hours-container {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      text-align: center;
      max-width: 1200px;
      width: 100%;
    }
    
    .left-sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100px;
      height: 100vh;
      background: #4a4c6b;
      color: #fff;
      z-index: 1001;
      transition: width 0.3s ease;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }
    
    .left-sidebar.expanded {
      width: 200px;
    }
    
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 50px 15px;
      cursor: pointer;
      height: 50px;
    }
    
    .sidebar-header h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.3s ease;
      position: absolute;
      left: 20px;
    }
    
    .left-sidebar.expanded .sidebar-header h3 {
      opacity: 1;
    }
    
    .sidebar-toggle {
      font-size: 2.5rem;
      cursor: pointer !important;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      transition: transform 0.3s ease;
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
      background: transparent;
      border: none;
      outline: none;
      margin: 0 auto;
      position: relative;
      top: 5px;
    }
    
    .left-sidebar.expanded .sidebar-toggle {
      height: 60px;
    }
    
    .left-sidebar.expanded .sidebar-toggle {
      transform: rotate(90deg);
    }
    
    .sidebar-close {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #fff;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 10;
      background: none;
      border: none;
      padding: 5px;
      border-radius: 4px;
    }
    
    .left-sidebar.expanded .sidebar-close {
      opacity: 1;
    }
    
    .sidebar-close:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    /* Hide only the toggle button when sidebar is expanded, keep the header and menu text */
    .left-sidebar.expanded .sidebar-toggle {
      display: none;
    }
    
    .sidebar-icons {
      padding: 10px 0;
    }
    
    .sidebar-icon-item {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 50px;
      color: #fff;
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }
    
    .sidebar-icon-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-left-color: #fff;
    }
    
    .sidebar-icon-item .icon {
      font-size: 1.3rem;
      filter: grayscale(60%);
    }
    
    .sidebar-text {
      padding: 20px 0;
    }
    
    .sidebar-text a {
      display: block;
      padding: 15px 20px;
      color: #fff;
      text-decoration: none;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }
    
    .sidebar-text a:hover {
      background: rgba(255, 255, 255, 0.1);
      border-left-color: #fff;
    }
    
    h1 {
      margin-bottom: 30px;
      color: #333;
      font-size: 2rem;
      font-weight: bold;
      text-align: center;
    }
    
    h2 {
      margin-bottom: 20px;
      color: #333;
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .refresh-indicator {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin: 10px 0;
    }
    
    .refreshing {
      color: #2d2e4b;
      font-weight: bold;
    }
    
    .last-updated {
      color: #333;
    }
    
    .user-hours-section {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      padding: 20px;
      text-align: left;
    }
    
    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .user-name {
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
    }
    
    .user-status {
      font-size: 0.9rem;
      padding: 4px 8px;
      border-radius: 4px;
      color: white;
    }
    
    .status-active {
      background: #2d2e4b;
    }
    
    .status-inactive {
      background: #6c757d;
    }
    
    .days-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
    }
    
    .day-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      border: 2px solid #e0e0e0;
      position: relative;
      transition: border-color 0.3s;
    }
    
    .day-card:hover {
      border-color: #2d2e4b;
    }
    
    .day-header {
      font-size: 0.9rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    
    .hours-display {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .hour-card {
      text-align: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 3px solid;
    }
    
    .work-hours {
      border-left-color: #2d2e4b;
    }
    
    .break-hours {
      border-left-color: #6c757d;
    }
    
    .hour-label {
      font-size: 0.8rem;
      color: #333;
      margin-bottom: 3px;
    }
    
    .hour-value {
      font-size: 1.1rem;
      font-weight: bold;
      color: #333;
    }
    
    .work-hours .hour-value {
      color: #2d2e4b;
    }
    
    .break-hours .hour-value {
      color: #6c757d;
    }
    
    .today-indicator {
      background: #e8e9f0;
      border: 2px solid #2d2e4b;
    }
    
    .real-time-indicator {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #2d2e4b;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
    }
    .hours-container {
      margin-bottom: 20px;
    }
    
    /* iPhone and small phones (up to 428px) */
    @media screen and (max-width: 428px) {
      :root {
        --scale-phone: 0.75;
        --scale-tablet: 0.8;
        --scale-desktop: 0.85;
        --scale-tv: 0.9;
      }
      
      body {
        font-size: calc(14px * var(--scale-phone));
        padding-left: calc(100px * var(--scale-phone)) !important;
        padding-top: 0 !important;
      }
      
      .left-sidebar {
        width: calc(100px * var(--scale-phone));
        height: 100vh;
        min-height: 100vh;
        overflow-y: auto;
        overflow-x: hidden;
      }
      
      .hours-container {
        padding: calc(15px * var(--scale-phone)) !important;
        margin: calc(10px * var(--scale-phone)) !important;
        max-width: calc(100vw - 20px) !important;
        width: calc(100vw - 20px) !important;
        overflow-x: hidden !important;
      }
      

      

      
      h1 {
        font-size: calc(1.5rem * var(--scale-phone));
        margin-bottom: calc(20px * var(--scale-phone));
      }
      
      h2 {
        font-size: calc(1.2rem * var(--scale-phone));
        margin-bottom: calc(15px * var(--scale-phone));
      }
      
      .user-hours-section {
        padding: calc(15px * var(--scale-phone));
        margin-bottom: calc(15px * var(--scale-phone));
      }
      
      .user-header {
        margin-bottom: calc(10px * var(--scale-phone));
        padding-bottom: calc(8px * var(--scale-phone));
      }
      
      .user-name {
        font-size: calc(1rem * var(--scale-phone));
      }
      
      .user-status {
        font-size: calc(0.8rem * var(--scale-phone));
        padding: calc(3px * var(--scale-phone)) calc(6px * var(--scale-phone));
      }
      
      .days-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: calc(8px * var(--scale-phone));
      }
      
      .day-card {
        padding: calc(10px * var(--scale-phone));
      }
      
      .day-header {
        font-size: calc(0.8rem * var(--scale-phone));
        margin-bottom: calc(8px * var(--scale-phone));
      }
      
      .hours-display {
        grid-template-columns: 1fr !important;
        gap: calc(5px * var(--scale-phone));
      }
      
      .hour-card {
        padding: calc(8px * var(--scale-phone));
      }
      
      .hour-label {
        font-size: calc(0.7rem * var(--scale-phone));
        margin-bottom: calc(2px * var(--scale-phone));
      }
      
      .hour-value {
        font-size: calc(1rem * var(--scale-phone));
      }
      
      .real-time-indicator {
        width: calc(16px * var(--scale-phone));
        height: calc(16px * var(--scale-phone));
        font-size: calc(0.6rem * var(--scale-phone));
        top: calc(-4px * var(--scale-phone));
        right: calc(-4px * var(--scale-phone));
      }
      
      .refresh-indicator {
        font-size: calc(12px * var(--scale-phone));
        margin: calc(8px * var(--scale-phone)) 0;
      }
    }
    
    /* iPhone 16 Pro and larger phones (429px - 768px) */
    @media screen and (min-width: 429px) and (max-width: 768px) {
      :root {
        --scale-phone: 0.65;
        --scale-tablet: 0.75;
        --scale-desktop: 0.8;
        --scale-tv: 0.9;
      }
      
      body {
        font-size: calc(15px * var(--scale-phone));
        padding-top: calc(55px * var(--scale-phone));
      }
      
      .hours-container {
        padding: calc(20px * var(--scale-phone));
        margin: calc(15px * var(--scale-phone));
        max-width: calc(100vw - 30px);
        width: calc(100vw - 30px);
      }
      

      

      
      h1 {
        font-size: calc(1.8rem * var(--scale-phone));
        margin-bottom: calc(25px * var(--scale-phone));
      }
      
      h2 {
        font-size: calc(1.3rem * var(--scale-phone));
        margin-bottom: calc(18px * var(--scale-phone));
      }
      
      .user-hours-section {
        padding: calc(18px * var(--scale-phone));
        margin-bottom: calc(18px * var(--scale-phone));
      }
      
      .user-header {
        margin-bottom: calc(12px * var(--scale-phone));
        padding-bottom: calc(10px * var(--scale-phone));
      }
      
      .user-name {
        font-size: calc(1.1rem * var(--scale-phone));
      }
      
      .user-status {
        font-size: calc(0.85rem * var(--scale-phone));
        padding: calc(4px * var(--scale-phone)) calc(7px * var(--scale-phone));
      }
      
      .days-grid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: calc(12px * var(--scale-phone));
      }
      
      .day-card {
        padding: calc(12px * var(--scale-phone));
      }
      
      .day-header {
        font-size: calc(0.85rem * var(--scale-phone));
        margin-bottom: calc(10px * var(--scale-phone));
      }
      
      .hours-display {
        grid-template-columns: 1fr 1fr !important;
        gap: calc(8px * var(--scale-phone));
      }
      
      .hour-card {
        padding: calc(10px * var(--scale-phone));
      }
      
      .hour-label {
        font-size: calc(0.75rem * var(--scale-phone));
        margin-bottom: calc(3px * var(--scale-phone));
      }
      
      .hour-value {
        font-size: calc(1.05rem * var(--scale-phone));
      }
      
      .real-time-indicator {
        width: calc(18px * var(--scale-phone));
        height: calc(18px * var(--scale-phone));
        font-size: calc(0.65rem * var(--scale-phone));
        top: calc(-5px * var(--scale-phone));
        right: calc(-5px * var(--scale-phone));
      }
      
      .refresh-indicator {
        font-size: calc(13px * var(--scale-phone));
        margin: calc(10px * var(--scale-phone)) 0;
      }
    }
    
    /* MacBook and laptop scaling (769px - 1439px) */
    @media screen and (min-width: 769px) and (max-width: 1439px) {
      :root {
        --scale-phone: 0.9;
        --scale-tablet: 0.95;
        --scale-desktop: 1;
        --scale-tv: 1.05;
      }
      
      body {
        font-size: calc(16px * var(--scale-desktop));
      }
      
      .hours-container {
        padding: calc(25px * var(--scale-desktop));
        max-width: calc(1200px * var(--scale-desktop));
      }
      

      
      
      h1 {
        font-size: calc(2rem * var(--scale-desktop));
        margin-bottom: calc(30px * var(--scale-desktop));
      }
      
      h2 {
        font-size: calc(1.5rem * var(--scale-desktop));
        margin-bottom: calc(20px * var(--scale-desktop));
      }
      
      .user-hours-section {
        padding: calc(20px * var(--scale-desktop));
        margin-bottom: calc(20px * var(--scale-desktop));
      }
      
      .user-header {
        margin-bottom: calc(15px * var(--scale-desktop));
        padding-bottom: calc(10px * var(--scale-desktop));
      }
      
      .user-name {
        font-size: calc(1.2rem * var(--scale-desktop));
      }
      
      .user-status {
        font-size: calc(0.9rem * var(--scale-desktop));
        padding: calc(4px * var(--scale-desktop)) calc(8px * var(--scale-desktop));
      }
      
      .days-grid {
        grid-template-columns: repeat(5, 1fr);
        gap: calc(15px * var(--scale-desktop));
      }
      
      .day-card {
        padding: calc(15px * var(--scale-desktop));
      }
      
      .day-header {
        font-size: calc(0.9rem * var(--scale-desktop));
        margin-bottom: calc(10px * var(--scale-desktop));
      }
      
      .hours-display {
        grid-template-columns: 1fr 1fr;
        gap: calc(10px * var(--scale-desktop));
      }
      
      .hour-card {
        padding: calc(10px * var(--scale-desktop));
      }
      
      .hour-label {
        font-size: calc(0.8rem * var(--scale-desktop));
        margin-bottom: calc(3px * var(--scale-desktop));
      }
      
      .hour-value {
        font-size: calc(1.1rem * var(--scale-desktop));
      }
      
      .real-time-indicator {
        width: calc(20px * var(--scale-desktop));
        height: calc(20px * var(--scale-desktop));
        font-size: calc(0.7rem * var(--scale-desktop));
        top: calc(-5px * var(--scale-desktop));
        right: calc(-5px * var(--scale-desktop));
      }
      
      .refresh-indicator {
        font-size: calc(14px * var(--scale-desktop));
        margin: calc(10px * var(--scale-desktop)) 0;
      }
    }
    
    /* Desktop monitors (1440px and up) */
    @media screen and (min-width: 1440px) {
      :root {
        --scale-phone: 1;
        --scale-tablet: 1.05;
        --scale-desktop: 1.1;
        --scale-tv: 1.2;
      }
      
      body {
        font-size: calc(16px * var(--scale-desktop));
      }
      
      .hours-container {
        padding: calc(30px * var(--scale-desktop));
        max-width: calc(1400px * var(--scale-desktop));
      }
      
      .navbar {
        height: calc(60px * var(--scale-desktop));
        padding: 0 calc(15px * var(--scale-desktop));
      }
      
      .navbar-hamburger {
        font-size: calc(2rem * var(--scale-desktop));
        padding: 0 calc(24px * var(--scale-desktop));
      }
      
      .navbar-title {
        font-size: calc(1.3rem * var(--scale-desktop));
        margin-left: 12px;
      }
      
      .sidebar {
        width: calc(220px * var(--scale-desktop));
        padding-top: calc(60px * var(--scale-desktop));
      }
      
      .sidebar a {
        padding: calc(18px * var(--scale-desktop)) calc(24px * var(--scale-desktop));
        font-size: calc(1.1rem * var(--scale-desktop));
      }
      
      h1 {
        font-size: calc(2.2rem * var(--scale-desktop));
        margin-bottom: calc(35px * var(--scale-desktop));
      }
      
      h2 {
        font-size: calc(1.6rem * var(--scale-desktop));
        margin-bottom: calc(25px * var(--scale-desktop));
      }
      
      .user-hours-section {
        padding: calc(25px * var(--scale-desktop));
        margin-bottom: calc(25px * var(--scale-desktop));
      }
      
      .user-header {
        margin-bottom: calc(20px * var(--scale-desktop));
        padding-bottom: calc(15px * var(--scale-desktop));
      }
      
      .user-name {
        font-size: calc(1.3rem * var(--scale-desktop));
      }
      
      .user-status {
        font-size: calc(1rem * var(--scale-desktop));
        padding: calc(5px * var(--scale-desktop)) calc(10px * var(--scale-desktop));
      }
      
      .days-grid {
        grid-template-columns: repeat(5, 1fr);
        gap: calc(20px * var(--scale-desktop));
      }
      
      .day-card {
        padding: calc(20px * var(--scale-desktop));
      }
      
      .day-header {
        font-size: calc(1rem * var(--scale-desktop));
        margin-bottom: calc(15px * var(--scale-desktop));
      }
      
      .hours-display {
        grid-template-columns: 1fr 1fr;
        gap: calc(15px * var(--scale-desktop));
      }
      
      .hour-card {
        padding: calc(15px * var(--scale-desktop));
      }
      
      .hour-label {
        font-size: calc(0.9rem * var(--scale-desktop));
        margin-bottom: calc(5px * var(--scale-desktop));
      }
      
      .hour-value {
        font-size: calc(1.2rem * var(--scale-desktop));
      }
      
      .real-time-indicator {
        width: calc(22px * var(--scale-desktop));
        height: calc(22px * var(--scale-desktop));
        font-size: calc(0.75rem * var(--scale-desktop));
        top: calc(-6px * var(--scale-desktop));
        right: calc(-6px * var(--scale-desktop));
      }
      
      .refresh-indicator {
        font-size: calc(15px * var(--scale-desktop));
        margin: calc(12px * var(--scale-desktop)) 0;
      }
    }
  </style>
</head>
<body>
  <div class="left-sidebar" id="leftSidebar">
    <div class="sidebar-header" onclick="toggleSidebar()">
      <h3>Menu</h3>
      <div class="sidebar-toggle" id="sidebarToggle">&#9776;</div>
    </div>
    <button class="sidebar-close" id="sidebarClose" onclick="toggleSidebar()">✕</button>
    
    <!-- Icon Mode -->
    <div class="sidebar-icons" id="sidebarIcons">
      <a href="#" class="sidebar-icon-item" id="dashboardIcon" title="Dashboard">
        <span class="icon">📊</span>
      </a>
      <a href="#" class="sidebar-icon-item" id="boardIcon" title="Board">
        <span class="icon">📋</span>
      </a>
      <a href="#" class="sidebar-icon-item" id="settingsIcon" title="Settings">
        <span class="icon">⚙️</span>
      </a>
      <a href="#" class="sidebar-icon-item" id="submitIcon" title="Submit Email">
        <span class="icon">📧</span>
      </a>
      <a href="#" class="sidebar-icon-item" id="viewEmailIcon" title="View Email">
        <span class="icon">📬</span>
      </a>
      <a href="#" class="sidebar-icon-item" id="hoursIcon" title="Hours">
        <span class="icon">⏱️</span>
      </a>
      <a href="#" class="sidebar-icon-item" id="editUsersIcon" title="Edit Users">
        <span class="icon">👥</span>
      </a>
      <a href="#" class="sidebar-icon-item" id="signOutIcon" title="Sign Out">
        <span class="icon">🚪</span>
      </a>
    </div>
    
    <!-- Text Mode -->
    <div class="sidebar-text" id="sidebarText" style="display: none;">
      <a href="#" id="dashboardLink">Dashboard</a>
      <a href="#" id="boardLink">Board</a>
      <a href="#" id="settingsLink">Settings</a>
      <a href="#" id="submitLink">Submit Email</a>
      <a href="#" id="viewEmailLink">View Email</a>
      <a href="#" id="hourLink">Hours</a>
      <a href="#" id="editUsersLink">Edit Users</a>
      <a href="#" id="signOutLink">Sign Out</a>
    </div>
  </div>
  
  <div class="hours-container">
    <h1>Weekly Hours (Mon-Fri)</h1>
    <div class="refresh-indicator" id="refreshIndicator">
      Auto-refreshing every 30 seconds.
    </div>
    <div id="hoursContainer"></div>
  </div>
  
  <script>
    // Function to convert decimal hours to HH:MM format
    function formatHours(hours) {
      const totalMinutes = Math.round(hours * 60);
      const h = Math.floor(totalMinutes / 60);
      const m = totalMinutes % 60;
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }

    // Function to update the refresh indicator
    function updateRefreshIndicator(message, className = '') {
      const indicator = document.getElementById('refreshIndicator');
      indicator.textContent = message;
      indicator.className = `refresh-indicator ${className}`;
    }

    // Function to get day name from date
    function getDayName(dateString) {
      // Always parse as local midnight to avoid timezone issues
      const date = new Date(dateString + 'T00:00:00');
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      return days[date.getDay()];
    }

    // Function to load and display hours data
    function loadHoursData() {
      updateRefreshIndicator('Refreshing data...', 'refreshing');
      
          // Fetch both weekly timesheets and current hours
    Promise.all([
      fetch(`${window.ApiUrlLink}/weekly_timesheets`).then(res => res.json()),
      fetch(`${window.ApiUrlLink}/current_hours`).then(res => res.json())
    ]).then(([weekData, currentData]) => {
        console.log('Weekly data:', weekData);
        console.log('Current hours data:', currentData);
        
        const today = new Date().toISOString().slice(0, 10);
        console.log('Today\'s date:', today);
        
        const currentMap = {};
        currentData.forEach(u => currentMap[u.username] = u);
        console.log('Current hours map:', currentMap);

        const container = document.getElementById('hoursContainer');
        container.innerHTML = ''; // Clear existing data
        
        weekData.users.forEach(user => {
          const userSection = document.createElement('div');
          userSection.className = 'user-hours-section';
          
          // User header with status
          const userHeader = document.createElement('div');
          userHeader.className = 'user-header';
          
          const userName = document.createElement('div');
          userName.className = 'user-name';
          userName.textContent = user.username;
          
          const userStatus = document.createElement('div');
          const hasCurrentData = currentMap[user.username];
          const isActive = hasCurrentData && (currentMap[user.username].status === "clocked-in" || currentMap[user.username].status === "break");
          userStatus.className = `user-status ${isActive ? 'status-active' : 'status-inactive'}`;
          userStatus.textContent = isActive ? 'Active' : 'Inactive';
          
          userHeader.appendChild(userName);
          userHeader.appendChild(userStatus);
          userSection.appendChild(userHeader);
          
          // Days grid
          const daysGrid = document.createElement('div');
          daysGrid.className = 'days-grid';
          
          user.days.forEach((day, i) => {
            const dayCard = document.createElement('div');
            const dayDate = weekData.week_dates[i];
            const isToday = dayDate === today;
            const isActive = hasCurrentData && (currentMap[user.username].status === "clocked-in" || currentMap[user.username].status === "break");
            
            dayCard.className = `day-card ${isToday ? 'today-indicator' : ''}`;
            
            // Day header
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header';
            dayHeader.textContent = getDayName(dayDate);
            dayCard.appendChild(dayHeader);
            
            // Hours display
            const hoursDisplay = document.createElement('div');
            hoursDisplay.className = 'hours-display';
            
            // Work hours
            const workHoursCard = document.createElement('div');
            workHoursCard.className = 'hour-card work-hours';
            
            const workLabel = document.createElement('div');
            workLabel.className = 'hour-label';
            workLabel.textContent = 'Work';
            
            const workValue = document.createElement('div');
            workValue.className = 'hour-value';
            
            // Break hours
            const breakHoursCard = document.createElement('div');
            breakHoursCard.className = 'hour-card break-hours';
            
            const breakLabel = document.createElement('div');
            breakLabel.className = 'hour-label';
            breakLabel.textContent = 'Break';
            
            const breakValue = document.createElement('div');
            breakValue.className = 'hour-value';
            
            // If this is today, and user is clocked in or on break, use real-time hours
            if (isToday && hasCurrentData && isActive) {
              const workHours = formatHours(Number(currentMap[user.username].work_hours));
              const breakHours = formatHours(Number(currentMap[user.username].break_hours));
              console.log(`Using real-time hours for ${user.username}: Work=${workHours}, Break=${breakHours}`);
              workValue.textContent = workHours;
              breakValue.textContent = breakHours;
              
              // Add real-time indicator
              const realTimeIndicator = document.createElement('div');
              realTimeIndicator.className = 'real-time-indicator';
              realTimeIndicator.textContent = 'L';
              dayCard.appendChild(realTimeIndicator);
            } else {
              const workHours = formatHours(Number(day.work_hours));
              const breakHours = formatHours(Number(day.break_hours));
              console.log(`Using saved hours for ${user.username}: Work=${workHours}, Break=${breakHours}`);
              workValue.textContent = workHours;
              breakValue.textContent = breakHours;
            }
            
            workHoursCard.appendChild(workLabel);
            workHoursCard.appendChild(workValue);
            breakHoursCard.appendChild(breakLabel);
            breakHoursCard.appendChild(breakValue);
            
            hoursDisplay.appendChild(workHoursCard);
            hoursDisplay.appendChild(breakHoursCard);
            dayCard.appendChild(hoursDisplay);
            daysGrid.appendChild(dayCard);
          });
          
          userSection.appendChild(daysGrid);
          container.appendChild(userSection);
        });
        
        // Update refresh indicator with last updated time
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        updateRefreshIndicator(`Last updated: ${timeString} | Auto-refreshing every 30 seconds...`, 'last-updated');
        
      }).catch(error => {
        console.error('Error fetching hours data:', error);
        document.getElementById('hoursContainer').innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">Error loading hours data</div>';
        updateRefreshIndicator('Error loading data. Retrying in 30 seconds...', '');
      });
    }

    // Sidebar functions
    function toggleSidebar() {
      console.log('Sidebar toggle clicked!');
      const sidebar = document.getElementById('leftSidebar');
      const icons = document.getElementById('sidebarIcons');
      const text = document.getElementById('sidebarText');
      
      if (sidebar.classList.contains('expanded')) {
        // Close the sidebar
        sidebar.classList.remove('expanded');
        icons.style.display = 'block';
        text.style.display = 'none';
        document.body.style.paddingLeft = '100px';
        console.log('Sidebar closed');
      } else {
        // Open the sidebar
        sidebar.classList.add('expanded');
        icons.style.display = 'none';
        text.style.display = 'block';
        document.body.style.paddingLeft = '200px';
        console.log('Sidebar opened');
      }
    }
    
    function signOut() {
      localStorage.removeItem('user');
      window.location.href = 'index.html';
    }
    
    // Get username from URL query parameter
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }
    
    const username = getQueryParam('username');
    
    // Wait for DOM and config to be loaded before making API calls
    document.addEventListener('DOMContentLoaded', function() {
      // Ensure config.js is loaded and ApiUrlLink is set
      if (typeof window.ApiUrlLink === 'undefined') {
        console.error('ApiUrlLink is not defined. Check config.js loading.');
        return;
      }

      if (!username) {
        window.location.href = "index.html";
        return;
      }

      console.log('Attempting to validate user:', username);
      console.log('API URL:', window.ApiUrlLink);
      
      // Add timeout to prevent hanging requests
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
      
      fetch(`${window.ApiUrlLink}/user/${username}`, {
        signal: controller.signal
      })
        .then(res => {
          clearTimeout(timeoutId); // Clear timeout on successful response
          console.log('API response status:', res.status);
          console.log('API response ok:', res.ok);
          
          if (!res.ok) {
            if (res.status === 404) {
              // User not found (deleted)
              alert('Your account has been deleted. You will be redirected to the login page.');
              localStorage.removeItem('user');
              window.location.href = "index.html";
              return;
            }
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(user => {
          if (!user) return; // User was deleted, already redirected
          
          // Check if user is admin
          if (user.role !== "admin") {
            alert('Access Denied. Admin privileges required to view hours.');
            window.location.href = `dashboard.html?username=${encodeURIComponent(username)}`;
            return;
          }
          
          // Note: userDisplay element doesn't exist in hours.html, so we skip setting it
          console.log('User validated successfully:', user.username);
          
          // Set up sidebar icon links
          if (username) {
            setupSidebarIconLinks(username);
          }
          
          // Set up sidebar event listeners
          const sidebarToggle = document.getElementById('sidebarToggle');
          const sidebarHeader = document.querySelector('.sidebar-header');
          
          if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function(e) {
              e.stopPropagation();
              toggleSidebar();
            });
          }
          
          if (sidebarHeader) {
            sidebarHeader.addEventListener('click', function(e) {
              e.stopPropagation();
              toggleSidebar();
            });
          }
          
          // Initial load
          loadHoursData();

          // Set up auto-refresh every 30 seconds
          const refreshInterval = setInterval(loadHoursData, 30000); // 30 seconds

          // Clean up interval when page is unloaded
          window.addEventListener('beforeunload', () => {
            clearInterval(refreshInterval);
          });
        })
        .catch((error) => {
          clearTimeout(timeoutId); // Clear timeout on error
          console.error('Error validating user:', error);
          console.error('Error details:', {
            message: error.message,
            stack: error.stack,
            name: error.name
          });
          
          if (error.name === 'AbortError') {
            alert('Request timed out. Please check your internet connection and try again.');
          } else {
            alert('Error validating your account. Please log in again. Error: ' + error.message);
          }
          
          localStorage.removeItem('user');
          window.location.href = "index.html";
                });
      });
      
      function setupSidebarIconLinks(username) {
        // Set href attributes for sidebar icons
        document.getElementById('dashboardIcon').href = `dashboard.html?username=${encodeURIComponent(username)}`;
        document.getElementById('boardIcon').href = `board.html?username=${encodeURIComponent(username)}`;
        document.getElementById('settingsIcon').href = `settings.html?username=${encodeURIComponent(username)}`;
        document.getElementById('submitIcon').href = `submit_email.html?username=${encodeURIComponent(username)}`;
        document.getElementById('viewEmailIcon').href = `view_email.html?username=${encodeURIComponent(username)}`;
        document.getElementById('hoursIcon').href = `hours.html?username=${encodeURIComponent(username)}`;
        document.getElementById('editUsersIcon').href = `users.html?username=${encodeURIComponent(username)}`;
        
        // Set href attributes for sidebar text links
        document.getElementById('dashboardLink').href = `dashboard.html?username=${encodeURIComponent(username)}`;
        document.getElementById('boardLink').href = `board.html?username=${encodeURIComponent(username)}`;
        document.getElementById('settingsLink').href = `settings.html?username=${encodeURIComponent(username)}`;
        document.getElementById('submitLink').href = `submit_email.html?username=${encodeURIComponent(username)}`;
        document.getElementById('viewEmailLink').href = `view_email.html?username=${encodeURIComponent(username)}`;
        document.getElementById('hourLink').href = `hours.html?username=${encodeURIComponent(username)}`;
        document.getElementById('editUsersLink').href = `users.html?username=${encodeURIComponent(username)}`;
        
        // Set up sign out functionality for both icon and text
        document.getElementById('signOutIcon').onclick = function(e) {
          e.preventDefault();
          localStorage.removeItem('user');
          window.location.href = 'index.html';
        };
        
        document.getElementById('signOutLink').onclick = function(e) {
          e.preventDefault();
          localStorage.removeItem('user');
          window.location.href = 'index.html';
        };
        
        // Hide hours navigation since we're already on the hours page
        document.getElementById('hoursIcon').style.display = 'none';
        document.getElementById('hourLink').style.display = 'none';
      }
       </script>
  </body>
  </html>
